<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; }
      pre { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 10px; min-height: 100px; }
      button { padding: 10px 15px; font-size: 16px; }
      table { border-collapse: collapse; width: 100%; margin-top: 10px; }
      th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
      th { background-color: #f2f2f2; }
    </style>
  </head>
  <body>
    <h1>Schedule To Contact - Web App</h1>
    <button id="generateBtn">連絡テキストを生成</button>
    
    <h2>生成結果:</h2>
    <pre id="result"></pre>
    
    <div id="warning" style="color: red; white-space: pre-wrap; margin-top: 10px; font-weight: bold;"></div>

    <h2>取得したカレンダーの予定</h2>
    <table id="eventTable">
      <thead>
        <tr>
          <th>日付</th>
          <th>時間</th>
          <th>タイトル</th>
        </tr>
      </thead>
      <tbody>
        <!-- Events will be inserted here by JavaScript -->
      </tbody>
    </table>

    <script>
      document.getElementById('generateBtn').addEventListener('click', function() {
        this.disabled = true;
        this.textContent = '生成中...';
        
        // Clear previous results
        document.getElementById('result').textContent = '';
        document.getElementById('warning').textContent = '';
        const tableBody = document.getElementById('eventTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';

        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById('result').textContent = response.mainOutput;
            document.getElementById('warning').textContent = response.missingKeywordsWarning;

            const tableBody = document.getElementById('eventTable').getElementsByTagName('tbody')[0];
            if (response.debugEvents && response.debugEvents.length > 0) {
              const eventsByDate = response.debugEvents.reduce(function (acc, event) {
                (acc[event.date] = acc[event.date] || []).push(event);
                return acc;
              }, {});

              for (const date in eventsByDate) {
                const events = eventsByDate[date];
                events.forEach(function(event, index) {
                  const row = tableBody.insertRow();
                  if (index === 0) {
                    const dateCell = row.insertCell();
                    dateCell.textContent = date;
                    dateCell.rowSpan = events.length;
                  }
                  const timeCell = row.insertCell();
                  timeCell.textContent = event.time;
                  const titleCell = row.insertCell();
                  titleCell.textContent = event.title;
                });
              }
            } else {
              const row = tableBody.insertRow();
              const cell1 = row.insertCell();
              cell1.colSpan = 3;
              cell1.textContent = '（予定なし）';
            }

            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').textContent = '連絡テキストを生成';
          })
          .withFailureHandler(function(error) {
            document.getElementById('warning').textContent = 'エラーが発生しました: ' + error.message;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').textContent = '連絡テキストを生成';
          })
          .generateTextForWebApp();
      });
    </script>
  </body>
</html>