<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; margin: 1em; font-size: 18px; }
      textarea { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 10px; min-height: 200px; font-size: 16px; width: 100%; box-sizing: border-box; }
      button { padding: 10px 15px; font-size: 16px; width: 100%; box-sizing: border-box; }
      table { border-collapse: collapse; width: 100%; margin-top: 10px; }
      th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
      th { background-color: #f2f2f2; }
      .table-container { overflow-x: auto; }

      @media screen and (max-width: 600px) {
        h1 { font-size: 1.5em; }
        h2 { font-size: 1.2em; }
      }
    </style>
  </head>
  <body>
    <h1>Schedule To Contact - Web App</h1>

    <div>
      <label for="yearSelect">対象年:</label>
      <select id="yearSelect"></select>
      <label for="monthSelect">対象月:</label>
      <select id="monthSelect"></select>
    </div>

    <button id="generateBtn" style="margin-top: 1em;">連絡テキストを生成</button>
    
    <h2>生成結果: <button id="copyBtn" type="button">コピー</button> <span id="copyNotification" style="display: none; color: green; font-weight: normal;">コピーしました！</span></h2>
    <textarea id="result"></textarea>
    
    <div id="warning" style="color: red; white-space: pre-wrap; margin-top: 10px; font-weight: bold;"></div>

    <h2>取得したカレンダーの予定</h2>
    <table id="eventTable">
      <thead>
        <tr>
          <th>日付</th>
          <th>時間</th>
          <th>タイトル</th>
        </tr>
      </thead>
      <tbody>
        <!-- Events will be inserted here by JavaScript -->
      </tbody>
    </table>

    <script>
      function populateDateSelectors() {
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const now = new Date();
        const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);

        const currentYear = now.getFullYear();
        for (let i = currentYear - 2; i <= currentYear + 2; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.text = i + '年';
          yearSelect.appendChild(option);
        }

        for (let i = 1; i <= 12; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.text = i + '月';
          monthSelect.appendChild(option);
        }

        yearSelect.value = nextMonth.getFullYear();
        monthSelect.value = nextMonth.getMonth() + 1;
      }

      document.addEventListener('DOMContentLoaded', populateDateSelectors);

      document.getElementById('generateBtn').addEventListener('click', function() {
        this.disabled = true;
        this.textContent = '生成中...';
        
        // Clear previous results
        document.getElementById('result').value = '';
        document.getElementById('warning').textContent = '';
        const tableBody = document.getElementById('eventTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';

        const year = parseInt(document.getElementById('yearSelect').value, 10);
        const month = parseInt(document.getElementById('monthSelect').value, 10);

        google.script.run
          .withSuccessHandler(function(response) {
            document.getElementById('result').value = response.mainOutput;
            document.getElementById('warning').textContent = response.missingKeywordsWarning;

            const tableBody = document.getElementById('eventTable').getElementsByTagName('tbody')[0];
            if (response.debugEvents && response.debugEvents.length > 0) {
              const eventsByDate = response.debugEvents.reduce(function (acc, event) {
                (acc[event.date] = acc[event.date] || []).push(event);
                return acc;
              }, {});

              for (const date in eventsByDate) {
                const events = eventsByDate[date];
                events.forEach(function(event, index) {
                  const row = tableBody.insertRow();
                  if (index === 0) {
                    const dateCell = row.insertCell();
                    dateCell.textContent = date;
                    dateCell.rowSpan = events.length;
                  }
                  const timeCell = row.insertCell();
                  timeCell.textContent = event.time;
                  const titleCell = row.insertCell();
                  titleCell.textContent = event.title;
                });
              }
            } else {
              const row = tableBody.insertRow();
              const cell1 = row.insertCell();
              cell1.colSpan = 3;
              cell1.textContent = '（予定なし）';
            }

            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').textContent = '連絡テキストを生成';
          })
          .withFailureHandler(function(error) {
            document.getElementById('warning').textContent = 'エラーが発生しました: ' + error.message;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').textContent = '連絡テキストを生成';
          })
          .generateTextForWebApp(year, month);
      });

      document.getElementById('copyBtn').addEventListener('click', function() {
        const resultText = document.getElementById('result').value;
        navigator.clipboard.writeText(resultText).then(function() {
          const notification = document.getElementById('copyNotification');
          notification.style.display = 'inline';
          setTimeout(function() {
            notification.style.display = 'none';
          }, 2000);
        }, function(err) {
          console.error('Could not copy text: ', err);
        });
      });
    </script>
  </body>
</html>